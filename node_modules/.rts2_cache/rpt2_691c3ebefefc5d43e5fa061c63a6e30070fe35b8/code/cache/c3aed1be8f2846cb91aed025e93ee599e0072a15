{"code":"import { reactive, readonly, toRaw } from './reactive';\r\nimport { ITERATE_KEY, track, trigger } from './effect';\r\nimport { extend, hasChanged, hasOwn, isArray, isIntegerKey, isObject } from '@vue/shared';\r\nimport { warn } from './warning';\r\nfunction createGetter(isReadonly = false, shallow = false) {\r\n    return function get(target, key, receiver) {\r\n        // 如果target已经被代理过了就直接返回true\r\n        if (key === \"__v_isReactive\" /* ReactiveFlags.IS_REACTIVE */) {\r\n            return !isReadonly;\r\n        }\r\n        else if (key === \"__v_isReadonly\" /* ReactiveFlags.IS_READONLY */) {\r\n            return isReadonly;\r\n        }\r\n        else if (key === \"__v_isShallow\" /* ReactiveFlags.IS_SHALLOW */) {\r\n            return shallow;\r\n        }\r\n        else if (key === \"__v_raw\" /* ReactiveFlags.RAW */) {\r\n            // 用于获取 receiver 的原始对象\r\n            return target;\r\n        }\r\n        const res = Reflect.get(target, key, receiver);\r\n        // 如果不是只读，触发getter收集副作用函数effect\r\n        if (!isReadonly) {\r\n            track(target, key);\r\n        }\r\n        // 如果是浅层次的读\r\n        if (shallow) {\r\n            return res;\r\n        }\r\n        // 如果返回的对象是对象，判断是否为 readonly ,如果是 readonly 那么递归调用readonly，保证深层次的对象也是只读的，reactive 同理，递归包裹深层次对象成为响应式，可以深层次的实现响应式\r\n        if (isObject(res)) {\r\n            return isReadonly ? readonly(res) : reactive(res);\r\n        }\r\n        return res;\r\n    };\r\n}\r\nfunction createSetter(shallow = false) {\r\n    return function set(target, key, value, receiver) {\r\n        // 拿到旧值,便于触发更新前的比较\r\n        let oldValue = target[key];\r\n        /**\r\n         *  # hadKey 这一步用来判断当前访问的key,是否是target自身的属性，如果是的话表示当前的set操作是修改数据，反之则是增添属性的操作\r\n         *\r\n         *  # hadKey 这一步其实有2个作用\r\n         *    1.针对数组，判断原始数组是否有这个key\r\n         *        如果当前的原始对象是数组类型，并且key是数字类型，或者字符串的数字类型( 0 or '0')，执行 Number(key) < target.length 判单数组有没有这个key\r\n         *    2.针对对象，判断原始对象是否有这个key\r\n         *        如果当前的原始对象是对象类型，执行 hasOwn(target, key) ，判断自身是否含有key（不包括原型链上的属性）\r\n         */\r\n        const hadKey = isArray(target) && isIntegerKey(key) ? Number(key) < target.length : hasOwn(target, key);\r\n        // 需要先设置值，再去追踪，重新执行副作用函数，否者执行副作用函数的时候值没有发生变化\r\n        const res = Reflect.set(target, key, value, receiver);\r\n        // 这里判断当前代理对象的原始对象是否为target,防止原型链响应式对象触发 setter 导致重复触发 trigger\r\n        if (target === toRaw(receiver)) {\r\n            // 如果没有访问的key，无论是对于数组还是对象，都是新增属性\r\n            if (!hadKey) {\r\n                trigger(target, key, \"add\" /* TriggerOpTypes.ADD */, value);\r\n            }\r\n            else if (hasChanged(value, oldValue)) { // 如果我们修改的属性值和原来的值一样，没必要去更新，影响性能\r\n                trigger(target, key, \"set\" /* TriggerOpTypes.SET */, value);\r\n            }\r\n        }\r\n        return res;\r\n    };\r\n}\r\n// 'foo' in p \r\nfunction has(target, key) {\r\n    const result = Reflect.has(target, key);\r\n    track(target, key);\r\n    return result;\r\n}\r\n// for key in p \r\nfunction ownKeys(target) {\r\n    // 判断当前遍历的对象是object类型还是数组类型\r\n    const key = isArray(target) ? 'length' : ITERATE_KEY;\r\n    track(target, key, \"iterate\" /* TrackOpTypes.ITERATE */);\r\n    return Reflect.ownKeys(target);\r\n}\r\n// 删除属性的时候触发\r\nfunction deleteProperty(target, key) {\r\n    // 判断要删除的属性是否存在当前的target身上\r\n    const hadKey = hasOwn(target, key);\r\n    const result = Reflect.deleteProperty(target, key);\r\n    // 当前 target 存在要删除的属性,并且成功删除了\r\n    if (result && hadKey) {\r\n        trigger(target, key, \"delete\" /* TriggerOpTypes.DELETE */);\r\n    }\r\n    return result;\r\n}\r\n// 深层次响应式模块的Handlers\r\nconst get = createGetter();\r\nconst set = createSetter();\r\nexport const mutableHandlers = {\r\n    get,\r\n    set,\r\n    has,\r\n    ownKeys,\r\n    deleteProperty\r\n};\r\n// 浅层次响应式模块的Handlers\r\nconst shallowGet = createGetter(false, true);\r\nconst shallowSet = createSetter(true);\r\nexport const shallowReactiveHandlers = extend({}, mutableHandlers, \r\n// 用 shallowReactiveHandlers 覆盖 mutableHandlers 当中的 get 和 set ，其余继承\r\n{\r\n    get: shallowGet,\r\n    set: shallowSet\r\n});\r\n// 只读模块的Handlers\r\nconst readonlyGet = createGetter(true);\r\nexport const readonlyHandlers = {\r\n    get: readonlyGet,\r\n    set(target, key) {\r\n        warn(`Set operation on key \"${String(key)}\" failed: target is readonly.`, target);\r\n        return true;\r\n    },\r\n    deleteProperty(target, key) {\r\n        warn(`Delete operation on key \"${String(key)}\" failed: target is readonly.`, target);\r\n        return true;\r\n    }\r\n};\r\n// 浅只读模块\r\nconst shallowReadonlyGet = createGetter(true, true);\r\nexport const shallowReadonlyHandlers = extend({}, readonlyHandlers, {\r\n    get: shallowReadonlyGet\r\n});\r\n//# sourceMappingURL=baseHandlers.js.map","references":["F:/forTest/v-rmake/packages/reactivity/src/reactive.ts","F:/forTest/v-rmake/packages/reactivity/src/effect.ts","F:/forTest/v-rmake/packages/shared/src/index.ts","F:/forTest/v-rmake/packages/reactivity/src/operations.ts","F:/forTest/v-rmake/packages/reactivity/src/warning.ts"],"map":"{\"version\":3,\"file\":\"baseHandlers.js\",\"sourceRoot\":\"\",\"sources\":[\"../../../../../packages/reactivity/src/baseHandlers.ts\"],\"names\":[],\"mappings\":\"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\"}"}
